
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Bootstraping &#8212; My book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'group1_lab4_python';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Non-Linear Methods DML" href="group1_lab5_python.html" />
    <link rel="prev" title="Proving Neyman Orthogonality" href="group1_lab3_python.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="group1_lab1_python.html">An inferential problem: The Gender Wage Gap</a></li>


<li class="toctree-l1"><a class="reference internal" href="group1_lab2_python.html">Multicollinearity</a></li>

<li class="toctree-l1"><a class="reference internal" href="group1_lab3_python.html">Proving Neyman Orthogonality</a></li>







<li class="toctree-l1 current active"><a class="current reference internal" href="#">Bootstraping</a></li>
<li class="toctree-l1"><a class="reference internal" href="group1_lab5_python.html">Non-Linear Methods DML</a></li>



</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fgroup1_lab4_python.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/group1_lab4_python.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Bootstraping</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workgroup-4">WORKGROUP 4</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">Loading libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-tg-and-create-t4">Filter tg and create T4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-dependent-and-independent-variable">Define dependent and independent variable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-run-the-ols-formula">Create and run the OLS formula</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-bootstrapping-function-like-boot-in-r">Create bootstrapping function like boot in R</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-a-sample-and-run-boot-function">Define a sample and run boot function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-the-results-of-bootstrapping">Save the results of bootstrapping</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#show-the-results-in-a-table">Show the results in a table</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#causal-forest">Causal Forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-the-tree-was-built">1. How the tree was built?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-ate">2. Estimate ATE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-best-linear-predictor-analysis">3. Run best linear predictor analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-school-wise-heterogeneity">4. Look at school-wise heterogeneity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-ignoring-clusters-how-do-the-results-change">5. Analysis ignoring clusters. How do the results change?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-without-fitting-the-propensity-score">6. Analysis without fitting the propensity score</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-plot-six-plots-in-the-make-some-plots-section-so-explain-what-you-find-there">7. The code plot six plots in the Make some plots section, so explain what you find there</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-school-level-covariates-by-treatment-heterogeneity">8. Visualize school-level covariates by treatment heterogeneity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cate-by-school">9. CATE by school</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="bootstraping">
<h1>Bootstraping<a class="headerlink" href="#bootstraping" title="Link to this heading">#</a></h1>
<section id="workgroup-4">
<h2>WORKGROUP 4<a class="headerlink" href="#workgroup-4" title="Link to this heading">#</a></h2>
<p>Integrantes:</p>
<ul class="simple">
<li><p>Valeria Hoyos Macedo</p></li>
<li><p>Josué Eduardo Maguiña Mezaz</p></li>
<li><p>Alvaro Alexander Yllu Socualaya</p></li>
<li><p>Maria pamela Cubas Albujar</p></li>
</ul>
<section id="loading-libraries">
<h3>Loading libraries<a class="headerlink" href="#loading-libraries" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="loading-data">
<h2>Loading data<a class="headerlink" href="#loading-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/alexanderquispe/CausalAI-Course/1b3b3368927b48ea4c9a13dc239b4665c938c838/data/penn_jae.csv&quot;</span><span class="p">)</span>
<span class="n">n_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;tg == 0 or tg == 4&#39;</span><span class="p">)</span>
<span class="n">n_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>abdt</th>
      <th>tg</th>
      <th>inuidur1</th>
      <th>inuidur2</th>
      <th>female</th>
      <th>black</th>
      <th>hispanic</th>
      <th>othrace</th>
      <th>dep</th>
      <th>...</th>
      <th>q5</th>
      <th>q6</th>
      <th>recall</th>
      <th>agelt35</th>
      <th>agegt54</th>
      <th>durable</th>
      <th>nondurable</th>
      <th>lusd</th>
      <th>husd</th>
      <th>muld</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>10824</td>
      <td>0</td>
      <td>18</td>
      <td>18</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>10824</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>10747</td>
      <td>0</td>
      <td>27</td>
      <td>27</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>10607</td>
      <td>4</td>
      <td>9</td>
      <td>9</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>13</td>
      <td>10831</td>
      <td>0</td>
      <td>27</td>
      <td>27</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div></div></div>
</div>
<section id="filter-tg-and-create-t4">
<h3>Filter tg and create T4<a class="headerlink" href="#filter-tg-and-create-t4" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_data</span> <span class="o">=</span> <span class="n">n_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;tg == 0 or tg == 4&#39;</span><span class="p">)</span>
<span class="n">n_data</span><span class="p">[</span><span class="s2">&quot;T4&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">n_data</span><span class="p">[[</span><span class="s1">&#39;tg&#39;</span><span class="p">]]</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">n_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>abdt</th>
      <th>tg</th>
      <th>inuidur1</th>
      <th>inuidur2</th>
      <th>female</th>
      <th>black</th>
      <th>hispanic</th>
      <th>othrace</th>
      <th>dep</th>
      <th>...</th>
      <th>q6</th>
      <th>recall</th>
      <th>agelt35</th>
      <th>agegt54</th>
      <th>durable</th>
      <th>nondurable</th>
      <th>lusd</th>
      <th>husd</th>
      <th>muld</th>
      <th>T4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>10824</td>
      <td>0</td>
      <td>18</td>
      <td>18</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>10824</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>10747</td>
      <td>0</td>
      <td>27</td>
      <td>27</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>10607</td>
      <td>4</td>
      <td>9</td>
      <td>9</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>13</td>
      <td>10831</td>
      <td>0</td>
      <td>27</td>
      <td>27</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 25 columns</p>
</div></div></div>
</div>
</section>
<section id="define-dependent-and-independent-variable">
<h3>Define dependent and independent variable<a class="headerlink" href="#define-dependent-and-independent-variable" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_data</span><span class="p">[</span><span class="s1">&#39;dependent_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_data</span><span class="p">[</span><span class="s1">&#39;inuidur1&#39;</span><span class="p">])</span>
<span class="n">independent_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;othrace&#39;</span><span class="p">,</span> <span class="s1">&#39;dep&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">,</span> <span class="s1">&#39;q4&#39;</span><span class="p">,</span> <span class="s1">&#39;q5&#39;</span><span class="p">,</span> <span class="s1">&#39;q6&#39;</span><span class="p">,</span> <span class="s1">&#39;agelt35&#39;</span><span class="p">,</span> <span class="s1">&#39;agegt54&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;durable&#39;</span><span class="p">,</span> <span class="s1">&#39;lusd&#39;</span><span class="p">,</span> <span class="s1">&#39;husd&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-and-run-the-ols-formula">
<h3>Create and run the OLS formula<a class="headerlink" href="#create-and-run-the-ols-formula" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_formula</span> <span class="o">=</span> <span class="s1">&#39;dependent_var ~ &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">independent_vars</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">model_formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">n_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                            OLS Regression Results                            
==============================================================================
Dep. Variable:          dependent_var   R-squared:                       0.029
Model:                            OLS   Adj. R-squared:                  0.026
Method:                 Least Squares   F-statistic:                     10.16
Date:                Fri, 28 Jun 2024   Prob (F-statistic):           2.00e-24
Time:                        03:40:03   Log-Likelihood:                -8151.3
No. Observations:                5099   AIC:                         1.633e+04
Df Residuals:                    5083   BIC:                         1.644e+04
Df Model:                          15                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      2.1784      0.159     13.701      0.000       1.867       2.490
T4            -0.0717      0.035     -2.021      0.043      -0.141      -0.002
female         0.1258      0.035      3.617      0.000       0.058       0.194
black         -0.2940      0.053     -5.550      0.000      -0.398      -0.190
othrace       -0.4704      0.198     -2.372      0.018      -0.859      -0.082
dep            0.0460      0.023      2.041      0.041       0.002       0.090
q2             0.0733      0.157      0.467      0.640      -0.234       0.381
q3            -0.0391      0.156     -0.250      0.803      -0.346       0.268
q4            -0.0556      0.157     -0.355      0.722      -0.362       0.251
q5            -0.1450      0.156     -0.930      0.352      -0.451       0.161
q6             0.0030      0.166      0.018      0.985      -0.323       0.329
agelt35       -0.1626      0.037     -4.401      0.000      -0.235      -0.090
agegt54        0.2278      0.059      3.868      0.000       0.112       0.343
durable        0.1266      0.048      2.629      0.009       0.032       0.221
lusd          -0.1756      0.041     -4.286      0.000      -0.256      -0.095
husd          -0.1056      0.045     -2.351      0.019      -0.194      -0.018
==============================================================================
Omnibus:                     1977.847   Durbin-Watson:                   1.989
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              471.957
Skew:                          -0.516   Prob(JB):                    3.28e-103
Kurtosis:                       1.924   Cond. No.                         33.9
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Save the results of the original model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">og_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Estimate&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]],</span>
    <span class="s1">&#39;Std. Error&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">bse</span><span class="p">[[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]]</span>
<span class="p">})</span>
<span class="n">og_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Estimate</th>
      <th>Std. Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T4</th>
      <td>T4</td>
      <td>-0.071659</td>
      <td>0.035460</td>
    </tr>
    <tr>
      <th>female</th>
      <td>female</td>
      <td>0.125810</td>
      <td>0.034780</td>
    </tr>
    <tr>
      <th>black</th>
      <td>black</td>
      <td>-0.293971</td>
      <td>0.052967</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="create-bootstrapping-function-like-boot-in-r">
<h3>Create bootstrapping function like boot in R<a class="headerlink" href="#create-bootstrapping-function-like-boot-in-r" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimates</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">boot_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">n_iterations</span><span class="p">):</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">estimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-a-sample-and-run-boot-function">
<h3>Define a sample and run boot function<a class="headerlink" href="#define-a-sample-and-run-boot-function" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_data</span><span class="p">))</span>
<span class="n">n_data_sampled</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">boot_fn</span><span class="p">(</span><span class="n">n_data_sampled</span><span class="p">,</span><span class="n">model_formula</span> <span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="save-the-results-of-bootstrapping">
<h3>Save the results of bootstrapping<a class="headerlink" href="#save-the-results-of-bootstrapping" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_t4</span><span class="p">,</span> <span class="n">mean_female</span><span class="p">,</span> <span class="n">mean_black</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">se_t4</span><span class="p">,</span> <span class="n">se_female</span><span class="p">,</span> <span class="n">se_black</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">boot_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Bootstrap Estimate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mean_t4</span><span class="p">,</span> <span class="n">mean_female</span><span class="p">,</span> <span class="n">mean_black</span><span class="p">],</span>
    <span class="s1">&#39;Bootstrap Std. Error&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">se_t4</span><span class="p">,</span> <span class="n">se_female</span><span class="p">,</span> <span class="n">se_black</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="n">og_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;Estimate&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF4500&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bootstrapping - T4&#39;s coefficient&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\Josue\AppData\Local\Temp\ipykernel_7548\1628013126.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[1])
C:\Users\Josue\anaconda3\Lib\site-packages\seaborn\_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context(&#39;mode.use_inf_as_na&#39;, True):
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &quot;Bootstrapping - T4&#39;s coefficient&quot;)
</pre></div>
</div>
<img alt="_images/11dfafa9b02bed8fb29d05fc945544b83e2ffa22149099409ff481ab922cba5e.png" src="_images/11dfafa9b02bed8fb29d05fc945544b83e2ffa22149099409ff481ab922cba5e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="n">og_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;Estimate&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF4500&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bootstrapping - female&#39;s coefficient&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\Josue\AppData\Local\Temp\ipykernel_7548\2810480946.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[2], )
C:\Users\Josue\anaconda3\Lib\site-packages\seaborn\_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context(&#39;mode.use_inf_as_na&#39;, True):
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &quot;Bootstrapping - female&#39;s coefficient&quot;)
</pre></div>
</div>
<img alt="_images/889e22ad14e2a71be1ca5a9201e22c88e3d7d2937280a18f35e6b1d23cbf4c7f.png" src="_images/889e22ad14e2a71be1ca5a9201e22c88e3d7d2937280a18f35e6b1d23cbf4c7f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="n">og_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;Estimate&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF4500&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bootstrapping - black&#39;s coefficient&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\Josue\AppData\Local\Temp\ipykernel_7548\2545363358.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `histplot` (an axes-level function for histograms).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  ax = sns.distplot(results[3], )
C:\Users\Josue\anaconda3\Lib\site-packages\seaborn\_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context(&#39;mode.use_inf_as_na&#39;, True):
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &quot;Bootstrapping - black&#39;s coefficient&quot;)
</pre></div>
</div>
<img alt="_images/7d2b20a56c7d39a28a38efb33656638c5d38c6a398637052985c5b2b3daf20f1.png" src="_images/7d2b20a56c7d39a28a38efb33656638c5d38c6a398637052985c5b2b3daf20f1.png" />
</div>
</div>
<section id="show-the-results-in-a-table">
<h4>Show the results in a table<a class="headerlink" href="#show-the-results-in-a-table" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bootstrap_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;t4&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Bootstrap Estimate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mean_t4</span><span class="p">,</span> <span class="n">mean_female</span><span class="p">,</span> <span class="n">mean_black</span><span class="p">],</span>
    <span class="s1">&#39;Bootstrap Std. Error&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">se_t4</span><span class="p">,</span> <span class="n">se_female</span><span class="p">,</span> <span class="n">se_black</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Convertir a DataFrame para mejor visualización</span>
<span class="n">original_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">og_results</span><span class="p">)</span>
<span class="n">bootstrap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bootstrap_results</span><span class="p">)</span>

<span class="c1"># Mostrar los resultados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original Model Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">original_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bootstrap Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bootstrap_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original Model Results
       Variable  Estimate  Std. Error
T4           T4 -0.071659    0.035460
female   female  0.125810    0.034780
black     black -0.293971    0.052967

Bootstrap Results
  Variable  Bootstrap Estimate  Bootstrap Std. Error
0       t4           -0.335115              0.084564
1   female            0.021172              0.077634
2    black           -0.318220              0.132706
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="causal-forest">
<h2>Causal Forest<a class="headerlink" href="#causal-forest" title="Link to this heading">#</a></h2>
</section>
<section id="how-the-tree-was-built">
<h2>1. How the tree was built?<a class="headerlink" href="#how-the-tree-was-built" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install econml</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">econml</span>
<span class="c1"># Main imports</span>
<span class="kn">from</span> <span class="nn">econml.orf</span> <span class="kn">import</span> <span class="n">DMLOrthoForest</span><span class="p">,</span> <span class="n">DROrthoForest</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">CausalForestDML</span>
<span class="kn">from</span> <span class="nn">econml.sklearn_extensions.linear_model</span> <span class="kn">import</span> <span class="n">WeightedLassoCVWrapper</span><span class="p">,</span> <span class="n">WeightedLasso</span><span class="p">,</span> <span class="n">WeightedLassoCV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">MultiTaskLassoCV</span>
<span class="c1"># Helper imports</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">econml.grf</span> <span class="kn">import</span> <span class="n">RegressionForest</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">line</span> <span class="mi">9</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">econml</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="c1"># Main imports</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">from</span> <span class="nn">econml.orf</span> <span class="kn">import</span> <span class="n">DMLOrthoForest</span><span class="p">,</span> <span class="n">DROrthoForest</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;econml&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;synthetic_data.csv&quot;</span><span class="p">)</span>
<span class="n">data_all</span><span class="p">[</span><span class="s2">&quot;schoolid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">data_all</span><span class="p">[</span><span class="s2">&quot;schoolid&quot;</span><span class="p">])</span>
<span class="n">data_all</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>schoolid</th>
      <th>Z</th>
      <th>Y</th>
      <th>S3</th>
      <th>C1</th>
      <th>C2</th>
      <th>C3</th>
      <th>XC</th>
      <th>X1</th>
      <th>X2</th>
      <th>X3</th>
      <th>X4</th>
      <th>X5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>76</td>
      <td>1</td>
      <td>0.081602</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>1</th>
      <td>76</td>
      <td>1</td>
      <td>-0.385869</td>
      <td>4</td>
      <td>12</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>76</td>
      <td>1</td>
      <td>0.398184</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>3</th>
      <td>76</td>
      <td>1</td>
      <td>-0.175037</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>4</th>
      <td>76</td>
      <td>1</td>
      <td>0.884583</td>
      <td>6</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10386</th>
      <td>1</td>
      <td>0</td>
      <td>0.423366</td>
      <td>7</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10387</th>
      <td>1</td>
      <td>0</td>
      <td>-0.197092</td>
      <td>7</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10388</th>
      <td>1</td>
      <td>0</td>
      <td>0.141698</td>
      <td>2</td>
      <td>15</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10389</th>
      <td>1</td>
      <td>0</td>
      <td>-0.351565</td>
      <td>5</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10390</th>
      <td>1</td>
      <td>0</td>
      <td>0.211240</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
  </tbody>
</table>
<p>10391 rows × 13 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DF</span> <span class="o">=</span> <span class="n">data_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">school_id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">data_all</span><span class="p">[</span><span class="s2">&quot;schoolid&quot;</span><span class="p">])</span>
<span class="n">school_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">max</span><span class="p">(</span><span class="n">school_id</span><span class="p">)])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">school_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">data_all</span><span class="p">[</span><span class="s2">&quot;schoolid&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
<span class="n">school_size</span> <span class="o">=</span> <span class="n">school_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all3</span><span class="o">=</span> <span class="n">data_all</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data_all3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>schoolid</th>
      <th>Z</th>
      <th>S3</th>
      <th>C1</th>
      <th>C2</th>
      <th>C3</th>
      <th>XC</th>
      <th>X1</th>
      <th>X2</th>
      <th>X3</th>
      <th>X4</th>
      <th>X5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>76</td>
      <td>1</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>1</th>
      <td>76</td>
      <td>1</td>
      <td>4</td>
      <td>12</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>2</th>
      <td>76</td>
      <td>1</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>3</th>
      <td>76</td>
      <td>1</td>
      <td>6</td>
      <td>4</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>4</th>
      <td>76</td>
      <td>1</td>
      <td>6</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>0.334544</td>
      <td>0.648586</td>
      <td>-1.310927</td>
      <td>0.224077</td>
      <td>-0.426757</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10386</th>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10387</th>
      <td>1</td>
      <td>0</td>
      <td>7</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10388</th>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>15</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10389</th>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
    <tr>
      <th>10390</th>
      <td>1</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>1.185986</td>
      <td>-1.129889</td>
      <td>1.009875</td>
      <td>1.005063</td>
      <td>-1.174702</td>
    </tr>
  </tbody>
</table>
<p>10391 rows × 12 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;Z ~ schoolid + S3+ C1+ C2+ C3+ XC+ X1+ X2+ X3+ X4+ X5&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">glm</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_all3</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">())</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:                      Z   No. Observations:                10391
Model:                            GLM   Df Residuals:                    10311
Model Family:                Binomial   Df Model:                           79
Link Function:                  Logit   Scale:                          1.0000
Method:                          IRLS   Log-Likelihood:                -6504.4
Date:                Thu, 06 Jun 2024   Deviance:                       13009.
Time:                        14:39:36   Pearson chi2:                 1.04e+04
No. Iterations:                   100   Pseudo R-squ. (CS):            0.01016
Covariance Type:            nonrobust                                         
==================================================================================
                     coef    std err          z      P&gt;|z|      [0.025      0.975]
----------------------------------------------------------------------------------
Intercept         -1.0478      0.140     -7.483      0.000      -1.322      -0.773
schoolid[T.2]     -0.0306      0.200     -0.153      0.878      -0.422       0.361
schoolid[T.3]     -0.0798      0.162     -0.493      0.622      -0.397       0.237
schoolid[T.4]      0.0336      0.159      0.211      0.833      -0.279       0.346
schoolid[T.5]     -0.0606      0.202     -0.299      0.765      -0.457       0.336
schoolid[T.6]      0.2010      0.181      1.111      0.266      -0.153       0.555
schoolid[T.7]      0.0377      0.195      0.193      0.847      -0.344       0.419
schoolid[T.8]      0.0385      0.203      0.189      0.850      -0.360       0.437
schoolid[T.9]     -0.2585      0.293     -0.884      0.377      -0.832       0.315
schoolid[T.10]    -0.0589      0.163     -0.362      0.717      -0.378       0.260
schoolid[T.11]    -0.1768      0.412     -0.429      0.668      -0.984       0.630
schoolid[T.12]    -0.3148      0.608     -0.518      0.605      -1.507       0.877
schoolid[T.13]     0.1251      0.305      0.411      0.681      -0.472       0.722
schoolid[T.14]    -0.5678      0.499     -1.137      0.255      -1.546       0.411
schoolid[T.15]    -0.0465      0.206     -0.226      0.821      -0.450       0.357
schoolid[T.16]    -0.0633      0.155     -0.408      0.683      -0.367       0.241
schoolid[T.17]     0.1698      0.270      0.629      0.529      -0.359       0.699
schoolid[T.18]    -0.1548      0.291     -0.531      0.595      -0.726       0.416
schoolid[T.19]     0.0312      0.199      0.157      0.876      -0.360       0.422
schoolid[T.20]    -0.1827      0.183     -0.999      0.318      -0.541       0.176
schoolid[T.21]    -0.1323      0.230     -0.575      0.565      -0.583       0.319
schoolid[T.22]    -0.5057      0.500     -1.012      0.312      -1.485       0.474
schoolid[T.23]     0.0841      0.284      0.296      0.768      -0.473       0.642
schoolid[T.24]    -0.1884      0.254     -0.740      0.459      -0.687       0.310
schoolid[T.25]     0.1625      0.125      1.299      0.194      -0.083       0.408
schoolid[T.26]    -0.0126      0.163     -0.077      0.938      -0.333       0.308
schoolid[T.27]    -0.1868      0.201     -0.931      0.352      -0.580       0.206
schoolid[T.28]    -0.3270      0.256     -1.279      0.201      -0.828       0.174
schoolid[T.29]    -0.1390      0.209     -0.665      0.506      -0.549       0.271
schoolid[T.30]    -0.2203      0.223     -0.988      0.323      -0.657       0.217
schoolid[T.31]     0.0599      0.551      0.109      0.913      -1.019       1.139
schoolid[T.32]     0.2081      0.301      0.691      0.489      -0.382       0.798
schoolid[T.33]     0.0893      0.297      0.301      0.764      -0.492       0.671
schoolid[T.34]     0.0015      0.167      0.009      0.993      -0.327       0.330
schoolid[T.35]    -0.2075      0.307     -0.676      0.499      -0.810       0.394
schoolid[T.36]    -0.1128      0.320     -0.352      0.724      -0.740       0.515
schoolid[T.37]     0.1019      0.203      0.503      0.615      -0.295       0.499
schoolid[T.38]    -0.1892      0.368     -0.514      0.607      -0.911       0.532
schoolid[T.39]    -0.4546      0.279     -1.632      0.103      -1.001       0.091
schoolid[T.40]    -0.3965      0.342     -1.159      0.246      -1.067       0.274
schoolid[T.41]    -0.1506      0.365     -0.413      0.680      -0.865       0.564
schoolid[T.42]     0.0150      0.261      0.058      0.954      -0.496       0.526
schoolid[T.43]    -0.4523      0.332     -1.362      0.173      -1.103       0.199
schoolid[T.44]     0.0330      0.278      0.119      0.906      -0.511       0.577
schoolid[T.45]     0.0313      0.203      0.154      0.878      -0.367       0.429
schoolid[T.46]    -0.1699      0.260     -0.654      0.513      -0.679       0.339
schoolid[T.47]    -0.0738      0.128     -0.578      0.563      -0.324       0.177
schoolid[T.48]    -0.2148      0.242     -0.886      0.376      -0.690       0.260
schoolid[T.49]    -0.0828      0.234     -0.354      0.723      -0.541       0.376
schoolid[T.50]     0.0620      0.315      0.197      0.844      -0.556       0.680
schoolid[T.51]     0.4486      0.356      1.260      0.208      -0.249       1.146
schoolid[T.52]    -0.1985      0.322     -0.616      0.538      -0.830       0.433
schoolid[T.53]    -0.1075      0.378     -0.284      0.776      -0.849       0.634
schoolid[T.54]    -0.0828      0.331     -0.251      0.802      -0.731       0.565
schoolid[T.55]    -0.1754      0.464     -0.378      0.705      -1.084       0.733
schoolid[T.56]     0.0127      0.374      0.034      0.973      -0.721       0.746
schoolid[T.57]     0.1296      0.155      0.836      0.403      -0.174       0.433
schoolid[T.58]     0.1145      0.189      0.607      0.544      -0.255       0.485
schoolid[T.59]     0.1475      0.192      0.770      0.441      -0.228       0.523
schoolid[T.60]    -0.0498      0.333     -0.150      0.881      -0.702       0.602
schoolid[T.61]    -0.0119      0.200     -0.059      0.953      -0.404       0.380
schoolid[T.62]     0.0607      0.125      0.484      0.628      -0.185       0.307
schoolid[T.63]    -0.0133      0.259     -0.051      0.959      -0.521       0.495
schoolid[T.64]     0.0201      0.132      0.152      0.879      -0.239       0.280
schoolid[T.65]     0.0016      0.302      0.005      0.996      -0.591       0.594
schoolid[T.66]    -0.1804      0.228     -0.790      0.430      -0.628       0.267
schoolid[T.67]    -0.0529      0.148     -0.357      0.721      -0.343       0.237
schoolid[T.68]    -0.2452      0.296     -0.829      0.407      -0.825       0.334
schoolid[T.69]    -0.1772      0.148     -1.197      0.231      -0.467       0.113
schoolid[T.70]    -0.1505      0.453     -0.332      0.740      -1.039       0.738
schoolid[T.71]    -0.0876      0.303     -0.289      0.772      -0.681       0.506
schoolid[T.72]     0.0071      0.149      0.048      0.962      -0.285       0.299
schoolid[T.73]    -0.1388      0.136     -1.024      0.306      -0.404       0.127
schoolid[T.74]    -0.0413      0.197     -0.209      0.834      -0.427       0.345
schoolid[T.75]    -0.1982      0.352     -0.563      0.574      -0.888       0.492
schoolid[T.76]     0.0166      0.165      0.101      0.920      -0.306       0.340
S3                 0.1036      0.020      5.250      0.000       0.065       0.142
C1                -0.0016      0.005     -0.295      0.768      -0.012       0.009
C2                -0.1039      0.042     -2.449      0.014      -0.187      -0.021
C3                -0.1319      0.046     -2.856      0.004      -0.222      -0.041
XC                 0.0256      0.030      0.848      0.397      -0.034       0.085
X1                -0.0720      0.056     -1.290      0.197      -0.181       0.037
X2                 0.0220      0.049      0.453      0.651      -0.073       0.117
X3                 0.0993      0.081      1.230      0.219      -0.059       0.258
X4                -0.0050      0.037     -0.135      0.893      -0.078       0.068
X5                -0.0284      0.072     -0.395      0.693      -0.169       0.113
==================================================================================
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Grow a forest. Add extra trees for the causal forest.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W</span> <span class="o">=</span> <span class="n">DF</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data_all</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span>
<span class="n">X_raw</span> <span class="o">=</span> <span class="n">DF</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_raw</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;S3&#39;, &#39;C1&#39;, &#39;C2&#39;, &#39;C3&#39;, &#39;XC&#39;, &#39;X1&#39;, &#39;X2&#39;, &#39;X3&#39;, &#39;X4&#39;, &#39;X5&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C1_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">DF</span><span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">],</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">XC_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">DF</span><span class="p">[</span><span class="s2">&quot;XC&quot;</span><span class="p">],</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;XC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_raw</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span><span class="s2">&quot;XC&quot;</span><span class="p">]),</span><span class="n">C1_exp</span><span class="p">,</span><span class="n">XC_exp</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;S3&#39;, &#39;C2&#39;, &#39;C3&#39;, &#39;X1&#39;, &#39;X2&#39;, &#39;X3&#39;, &#39;X4&#39;, &#39;X5&#39;, &#39;C1_1&#39;, &#39;C1_2&#39;, &#39;C1_3&#39;,
       &#39;C1_4&#39;, &#39;C1_5&#39;, &#39;C1_6&#39;, &#39;C1_7&#39;, &#39;C1_8&#39;, &#39;C1_9&#39;, &#39;C1_10&#39;, &#39;C1_11&#39;,
       &#39;C1_12&#39;, &#39;C1_13&#39;, &#39;C1_14&#39;, &#39;C1_15&#39;, &#39;XC_0&#39;, &#39;XC_1&#39;, &#39;XC_2&#39;, &#39;XC_3&#39;,
       &#39;XC_4&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preparing data to fit a causal forest</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="s1">&#39;schoolid + S3+ C1+ C2+ C3+ XC+ X1+ X2+ X3+ X4+ X5&#39;</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">fmla</span><span class="p">)</span>
<span class="n">desc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data_all</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">DF</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="c1">#treatment</span>
<span class="c1">#Y = data_all[&quot;Z&quot;] #post-treatment</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">DF</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
<span class="c1">#X_raw = DF.iloc[:,2:]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span>
<span class="n">W_n</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Estimate a causal forest.</span>
<span class="n">est2</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">model_y</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="n">est2</span><span class="o">.</span><span class="n">tune</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W_n</span><span class="p">)</span>
<span class="n">est2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W_n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;econml.dml.causal_forest.CausalForestDML at 0x136f78350&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get residuals  and propensity </span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W_n</span><span class="p">,</span> <span class="n">cache_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">residuals_</span>
<span class="n">W_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">e_hat</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">W_res</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Prop</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;p_score&quot;</span><span class="p">:</span><span class="n">e_hat</span><span class="p">,</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">:</span><span class="n">W</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tau_hat</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span> <span class="c1"># tau(X) estimates</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tau_hat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.27387535, 0.24592375, 0.25906053, ..., 0.19462195, 0.19472672,
       0.18980818])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">est2</span><span class="o">.</span><span class="n">feature_importances</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.00000000e+00, 1.61245189e-04, 0.00000000e+00, 1.96229324e-04,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.72255634e-05,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       1.18442318e-03, 0.00000000e+00, 0.00000000e+00, 3.06974587e-03,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 4.48286137e-04, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       1.87070829e-04, 4.40583547e-04, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 8.13976838e-04, 0.00000000e+00, 7.28629552e-05,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 3.52387586e-05,
       1.12022728e-03, 6.34251974e-03, 0.00000000e+00, 0.00000000e+00,
       2.38918711e-02, 1.17726352e-01, 6.60012221e-02, 3.59633340e-02,
       3.32754416e-02, 2.31751580e-01, 1.35044789e-01, 7.45509898e-02,
       8.67073067e-02, 1.80997479e-01])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;covariaties&quot;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;values&quot;</span> <span class="p">:</span> <span class="n">est2</span><span class="o">.</span><span class="n">feature_importances</span><span class="p">()})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">importance</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>covariaties</th>
      <th>values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>81</th>
      <td>X1</td>
      <td>0.231752</td>
    </tr>
    <tr>
      <th>85</th>
      <td>X5</td>
      <td>0.180997</td>
    </tr>
    <tr>
      <th>82</th>
      <td>X2</td>
      <td>0.135045</td>
    </tr>
    <tr>
      <th>77</th>
      <td>C1</td>
      <td>0.117726</td>
    </tr>
    <tr>
      <th>84</th>
      <td>X4</td>
      <td>0.086707</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>schoolid[T.31]</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>schoolid[T.30]</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>28</th>
      <td>schoolid[T.29]</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>schoolid[T.27]</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>43</th>
      <td>schoolid[T.44]</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>86 rows × 2 columns</p>
</div></div></div>
</div>
<p>Data-driven subgroup</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fmla = &#39;schoolid + S3+ C1+ C2+ C3+ XC+ X1+ X2+ X3+ X4+ X5&#39;</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="s1">&#39;0+ schoolid + S3+ C1+ C2+ C3+ XC+ X1+ X2+ X3+ X4+ X5&#39;</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">fmla</span><span class="p">)</span>
<span class="n">desc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data_all</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">DF</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="c1">#treatment</span>
<span class="c1">#Y = data_all[&quot;Z&quot;] #post-treatment</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">DF</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="c1">#post-treatment</span>
<span class="c1">#X_raw = DF.iloc[:,2:]</span>
<span class="n">W_n</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cluster_causal_forest</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span>  <span class="n">cluster</span><span class="p">):</span>        
        
        <span class="n">base</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
        
            <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="n">cluster</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>  <span class="c1">## split index</span>
            
            <span class="n">Y</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">XX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">causal</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">model_y</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
            <span class="n">causal</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">XX</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
            
            <span class="n">tau_hat</span> <span class="o">=</span> <span class="n">causal</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),:])</span> <span class="c1"># tau(X) estimates using validation data</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;tau_hat&quot;</span><span class="p">:</span><span class="n">tau_hat</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">:</span><span class="n">vector</span><span class="p">})</span>
       
        <span class="n">tau_predict</span> <span class="o">=</span> <span class="n">data_0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">tau_predict</span> <span class="o">=</span> <span class="n">tau_predict</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">tau_predict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_folds</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_rankings</span> <span class="o">=</span> <span class="mi">5</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tau_hat_cluster</span> <span class="o">=</span> <span class="n">cluster_causal_forest</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">W_n</span><span class="p">,</span>  <span class="n">cluster</span> <span class="o">=</span> <span class="n">num_folds</span><span class="p">)</span>

<span class="n">data_all</span><span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_folds</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">tau_hat_cluster</span><span class="o">.</span><span class="n">Cluster</span> <span class="o">==</span> <span class="n">i</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">tau_hat_cluster</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">tau_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">tau_hat_cluster</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)))</span>
    <span class="n">labels</span> <span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span> <span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ranking&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">tau_hat_cluster</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;tau_hat&quot;</span><span class="p">],</span> 
                                               <span class="n">tau_quantile</span> <span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>

<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)

<span class="nn">/var/folders/bp/p_j4tl057jbbd0cmp6xbd9pw0000gn/T/ipykernel_15144/2436848413.py</span> in <span class="ni">?</span><span class="nt">()</span>

<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">tau_hat_cluster</span> <span class="o">=</span> <span class="n">cluster_causal_forest</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">W_n</span><span class="p">,</span>  <span class="n">cluster</span> <span class="o">=</span> <span class="n">num_folds</span><span class="p">)</span>

<span class="g g-Whitespace">      </span><span class="mi">2</span> 

<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">data_all</span><span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="g g-Whitespace">      </span><span class="mi">4</span> 



<span class="nn">/var/folders/bp/p_j4tl057jbbd0cmp6xbd9pw0000gn/T/ipykernel_15144/2136244812.py</span> in <span class="ni">?</span><span class="nt">(Y, T, X, W, cluster)</span>

<span class="g g-Whitespace">     </span><span class="mi">23</span> 

<span class="g g-Whitespace">     </span><span class="mi">24</span>         <span class="n">tau_predict</span> <span class="o">=</span> <span class="n">data_0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="g g-Whitespace">     </span><span class="mi">25</span> 

<span class="g g-Whitespace">     </span><span class="mi">26</span>         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>

<span class="ne">---&gt; </span><span class="mi">27</span>             <span class="n">tau_predict</span> <span class="o">=</span> <span class="n">tau_predict</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;data_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="g g-Whitespace">     </span><span class="mi">28</span> 

<span class="g g-Whitespace">     </span><span class="mi">29</span>         <span class="k">return</span> <span class="n">tau_predict</span>



<span class="nn">~/Downloads/anaconda3/lib/python3.11/site-packages/pandas/core/generic.py</span> in <span class="ni">?</span><span class="nt">(self, name)</span>

<span class="g g-Whitespace">   </span><span class="mi">6200</span>             <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessors</span>

<span class="g g-Whitespace">   </span><span class="mi">6201</span>             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_axis</span><span class="o">.</span><span class="n">_can_hold_identifiers_and_holds_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="g g-Whitespace">   </span><span class="mi">6202</span>         <span class="p">):</span>

<span class="g g-Whitespace">   </span><span class="mi">6203</span>             <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="ne">-&gt; </span><span class="mi">6204</span>         <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>



<span class="ne">AttributeError</span>: &#39;DataFrame&#39; object has no attribute &#39;concat&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimate-ate">
<h2>2. Estimate ATE<a class="headerlink" href="#estimate-ate" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ATE</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># Calcular el intervalo de confianza del 95% para el ATE</span>
<span class="n">ci_lower</span> <span class="o">=</span> <span class="n">ATE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ci_upper</span> <span class="o">=</span> <span class="n">ATE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># Imprimir el resultado</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;95% CI for the ATE:&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">ATE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
      <span class="s2">&quot;+/-&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATE</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>95% CI for the ATE: 0.226 +/- 0.485
</pre></div>
</div>
</div>
</div>
<p>With the tuned parameters, we estimate the average treatment effect (ATE) that is 0.226 and has a confidence interval (+/-0.0485) with a 95/% confidence. This means that the effect of the treatment or the intervetion related to the growth mind set had a positive and significant impact on the measure of achievement of the students on average.</p>
</section>
<section id="run-best-linear-predictor-analysis">
<h2>3. Run best linear predictor analysis<a class="headerlink" href="#run-best-linear-predictor-analysis" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tau_hat</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing AIPW scores.</span>
<span class="n">tau_hat</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span> <span class="c1">#E[Y|X]</span>

<span class="n">residuals</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W_n</span><span class="p">,</span> <span class="n">cache_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">residuals_</span>
<span class="n">W_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">e_hat</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">W_res</span>  <span class="c1"># P[W=1|X]</span>

<span class="n">Y_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_res</span> <span class="c1"># E[Y|X]</span>

<span class="n">mu_hat0</span> <span class="o">=</span> <span class="n">m_hat</span> <span class="o">-</span> <span class="n">e_hat</span> <span class="o">*</span> <span class="n">tau_hat</span>        <span class="c1"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span>
<span class="n">mu_hat1</span> <span class="o">=</span> <span class="n">m_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e_hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_hat</span>  <span class="c1"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span>

<span class="c1"># AIPW scores</span>
<span class="n">data_all</span><span class="p">[</span><span class="s1">&#39;aipw_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_hat</span> <span class="o">+</span> <span class="n">W</span> <span class="o">/</span> <span class="n">e_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu_hat1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e_hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu_hat0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">=</span><span class="n">data_all</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;m_hat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_hat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;m_hat ~ schoolid + S3+ C1+ C2+ C3+ XC+ X1+ X2+ X3+ X4+ X5&#39;</span><span class="p">,</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span> <span class="o">=</span> <span class="s1">&#39;HC3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">summary2</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>covariance of constraints does not have full rank. The number of constraints is 85, but rank is 80
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef.</th>
      <th>Std.Err.</th>
      <th>z</th>
      <th>P&gt;|z|</th>
      <th>[0.025</th>
      <th>0.975]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Intercept</th>
      <td>-1.164420</td>
      <td>0.016119</td>
      <td>-72.236890</td>
      <td>0.000000e+00</td>
      <td>-1.196014</td>
      <td>-1.132827</td>
    </tr>
    <tr>
      <th>schoolid[T.2]</th>
      <td>0.059962</td>
      <td>0.011997</td>
      <td>4.997993</td>
      <td>5.793009e-07</td>
      <td>0.036448</td>
      <td>0.083477</td>
    </tr>
    <tr>
      <th>schoolid[T.3]</th>
      <td>0.092527</td>
      <td>0.009995</td>
      <td>9.257676</td>
      <td>2.089294e-20</td>
      <td>0.072938</td>
      <td>0.112116</td>
    </tr>
    <tr>
      <th>schoolid[T.4]</th>
      <td>-0.019255</td>
      <td>0.010842</td>
      <td>-1.775899</td>
      <td>7.574956e-02</td>
      <td>-0.040506</td>
      <td>0.001996</td>
    </tr>
    <tr>
      <th>schoolid[T.5]</th>
      <td>0.024309</td>
      <td>0.013992</td>
      <td>1.737416</td>
      <td>8.231375e-02</td>
      <td>-0.003114</td>
      <td>0.051732</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>X1</th>
      <td>-0.066211</td>
      <td>0.003840</td>
      <td>-17.241730</td>
      <td>1.291148e-66</td>
      <td>-0.073737</td>
      <td>-0.058684</td>
    </tr>
    <tr>
      <th>X2</th>
      <td>-0.030225</td>
      <td>0.003215</td>
      <td>-9.400628</td>
      <td>5.423859e-21</td>
      <td>-0.036526</td>
      <td>-0.023923</td>
    </tr>
    <tr>
      <th>X3</th>
      <td>0.027256</td>
      <td>0.004857</td>
      <td>5.611318</td>
      <td>2.007910e-08</td>
      <td>0.017736</td>
      <td>0.036776</td>
    </tr>
    <tr>
      <th>X4</th>
      <td>0.002308</td>
      <td>0.002809</td>
      <td>0.821678</td>
      <td>4.112604e-01</td>
      <td>-0.003198</td>
      <td>0.007814</td>
    </tr>
    <tr>
      <th>X5</th>
      <td>0.041985</td>
      <td>0.004432</td>
      <td>9.474063</td>
      <td>2.691668e-21</td>
      <td>0.033299</td>
      <td>0.050670</td>
    </tr>
  </tbody>
</table>
<p>86 rows × 6 columns</p>
</div></div></div>
</div>
<p>It finds that if we insists in cluster-robust inference, there’s almost no treatment heterogenity present and thus that the causal forest couldn’t identify subgroups with effects at stand.</p>
<p>Due to this, they try to found if there’s heterogenity between two specific variables: pre-existing mindset and school-level achievement. They find that schools with larger values of pre-existing mindset have larger effects than schools with smaller values of this variables. However, they do not see much heterogeneity along school-level achievement.</p>
</section>
<section id="look-at-school-wise-heterogeneity">
<h2>4. Look at school-wise heterogeneity<a class="headerlink" href="#look-at-school-wise-heterogeneity" title="Link to this heading">#</a></h2>
<p>As seen before, there’s much perceivable heterogenety at school-level. In order to see if this help us to identify heteregenous effects, we fit models using only school-level covariates. This fact seems to be presented on the next graphs, where the distribution of the school treatment effects and the student expectation success propensity score are shown</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">school_score</span> <span class="o">=</span> <span class="n">school_mat</span> <span class="o">/</span> <span class="n">school_size</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># Configura el tamaño de la figura</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

<span class="c1"># Crear el histograma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">school_score</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Etiquetas y título</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;School Treatment Effect Estimate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Mostrar el gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5ac1e8615cbbda10c5456e22554eeb63a51d631d033b4190bfa7121056e87dc0.png" src="_images/5ac1e8615cbbda10c5456e22554eeb63a51d631d033b4190bfa7121056e87dc0.png" />
</div>
</div>
</section>
<section id="analysis-ignoring-clusters-how-do-the-results-change">
<h2>5. Analysis ignoring clusters. How do the results change?<a class="headerlink" href="#analysis-ignoring-clusters-how-do-the-results-change" title="Link to this heading">#</a></h2>
<p>We have seen until now no evidence on heteregenious effects of the treatment considering clusters. This mean we have token into account the possible correlation between students that attend the same school. Althought it will be naive to be believed that this doesn’t happend, it will helpful to analyse whether there exist consistent difference</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimator</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>
                            <span class="n">model_y</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>
                            <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Ajuste del modelo causal</span>
<span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Estimación del ATE</span>
<span class="n">ATE_noclust</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">ate</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">ATE_mean</span> <span class="o">=</span> <span class="n">ATE_noclust</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ATE_ci</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATE_noclust</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% CI for the ATE: </span><span class="si">{</span><span class="n">ATE_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">ATE_ci</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Predicción tau.hat.noclust</span>
<span class="n">tau_hat_noclust</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Plot de school.id vs tau.hat.noclust</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">school_id</span><span class="p">,</span> <span class="n">tau_hat_noclust</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;School ID&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Tau Hat (No Clustering)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Cross-validation para tau.hat.crossfold</span>
<span class="n">nfold</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">school_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">school_id</span><span class="p">)</span>
<span class="n">cluster_folds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">school_levels</span><span class="p">))</span>

<span class="n">tau_hat_crossfold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">foldid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">foldid</span><span class="p">)</span>
    <span class="n">infold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">school_id</span><span class="p">,</span> <span class="n">school_levels</span><span class="p">[</span><span class="n">cluster_folds</span> <span class="o">==</span> <span class="n">foldid</span><span class="p">])</span>
    
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">infold</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">infold</span><span class="p">]</span>
    <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">~</span><span class="n">infold</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">infold</span><span class="p">]</span>
    <span class="n">W_train</span><span class="p">,</span> <span class="n">W_test</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="o">~</span><span class="n">infold</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">infold</span><span class="p">]</span>
    <span class="n">Y_hat_train</span><span class="p">,</span> <span class="n">W_hat_train</span> <span class="o">=</span> <span class="n">Y_hat</span><span class="p">[</span><span class="o">~</span><span class="n">infold</span><span class="p">],</span> <span class="n">W_hat</span><span class="p">[</span><span class="o">~</span><span class="n">infold</span><span class="p">]</span>
    
    <span class="n">estimator_fold</span> <span class="o">=</span> <span class="n">C</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>

<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)

<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">311</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>

<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">estimator</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>

<span class="g g-Whitespace">      </span><span class="mi">2</span>                             <span class="n">model_y</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>

<span class="g g-Whitespace">      </span><span class="mi">3</span>                             <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

<span class="g g-Whitespace">      </span><span class="mi">4</span>                             <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="c1"># Ajuste del modelo causal</span>

<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>

<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="c1"># Estimación del ATE</span>

<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">ATE_noclust</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">ate</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>



<span class="nn">File ~/Downloads/anaconda3/lib/python3.11/site-packages/econml/dml/causal_forest.py:854,</span> in <span class="ni">CausalForestDML.fit</span><span class="nt">(self, Y, T, X, W, sample_weight, groups, cache_values, inference)</span>

<span class="g g-Whitespace">    </span><span class="mi">852</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="g g-Whitespace">    </span><span class="mi">853</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This estimator does not support X=None!&quot;</span><span class="p">)</span>

<span class="ne">--&gt; </span><span class="mi">854</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">855</span>                    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">856</span>                    <span class="n">cache_values</span><span class="o">=</span><span class="n">cache_values</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">857</span>                    <span class="n">inference</span><span class="o">=</span><span class="n">inference</span><span class="p">)</span>



<span class="nn">File ~/Downloads/anaconda3/lib/python3.11/site-packages/econml/dml/_rlearner.py:422,</span> in <span class="ni">_RLearner.fit</span><span class="nt">(self, Y, T, X, W, sample_weight, freq_weight, sample_var, groups, cache_values, inference)</span>

<span class="g g-Whitespace">    </span><span class="mi">385</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>

<span class="g g-Whitespace">    </span><span class="mi">386</span><span class="sd"> Estimate the counterfactual model from data, i.e. estimates function :math:`\\theta(\\cdot)`.</span>

<span class="g g-Whitespace">    </span><span class="mi">387</span><span class="sd"> </span>

<span class="sd">   (...)</span>

<span class="g g-Whitespace">    </span><span class="mi">419</span><span class="sd"> self: _RLearner instance</span>

<span class="g g-Whitespace">    </span><span class="mi">420</span><span class="sd"> &quot;&quot;&quot;</span>

<span class="g g-Whitespace">    </span><span class="mi">421</span> <span class="c1"># Replacing fit from _OrthoLearner, to enforce Z=None and improve the docstring</span>

<span class="ne">--&gt; </span><span class="mi">422</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">423</span>                    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">freq_weight</span><span class="o">=</span><span class="n">freq_weight</span><span class="p">,</span> <span class="n">sample_var</span><span class="o">=</span><span class="n">sample_var</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">424</span>                    <span class="n">cache_values</span><span class="o">=</span><span class="n">cache_values</span><span class="p">,</span>

<span class="g g-Whitespace">    </span><span class="mi">425</span>                    <span class="n">inference</span><span class="o">=</span><span class="n">inference</span><span class="p">)</span>



<span class="nn">File ~/Downloads/anaconda3/lib/python3.11/site-packages/econml/_cate_estimator.py:131,</span> in <span class="ni">BaseCateEstimator._wrap_fit.&lt;locals&gt;.call</span><span class="nt">(self, Y, T, inference, *args, **kwargs)</span>

<span class="g g-Whitespace">    </span><span class="mi">129</span>     <span class="n">inference</span><span class="o">.</span><span class="n">prefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="g g-Whitespace">    </span><span class="mi">130</span> <span class="c1"># call the wrapped fit method</span>

<span class="ne">--&gt; </span><span class="mi">131</span> <span class="n">m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="g g-Whitespace">    </span><span class="mi">132</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postfit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">if</span> <span class="n">inference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="c1"># NOTE: we call inference fit *after* calling the main fit method</span>



<span class="nn">File ~/Downloads/anaconda3/lib/python3.11/site-packages/econml/_ortho_learner.py:761,</span> in <span class="ni">_OrthoLearner.fit</span><span class="nt">(self, Y, T, X, W, Z, sample_weight, freq_weight, sample_var, groups, cache_values, inference, only_final, check_input)</span>

<span class="g g-Whitespace">    </span><span class="mi">757</span>     <span class="n">X</span><span class="p">,</span> <span class="o">=</span> <span class="n">check_input_arrays</span><span class="p">(</span>

<span class="g g-Whitespace">    </span><span class="mi">758</span>         <span class="n">X</span><span class="p">,</span> <span class="n">force_all_finite</span><span class="o">=</span><span class="s1">&#39;allow-nan&#39;</span> <span class="k">if</span> <span class="s1">&#39;X&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_allowed_missing_vars</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>

<span class="g g-Whitespace">    </span><span class="mi">759</span>     <span class="n">W</span><span class="p">,</span> <span class="o">=</span> <span class="n">check_input_arrays</span><span class="p">(</span>

<span class="g g-Whitespace">    </span><span class="mi">760</span>         <span class="n">W</span><span class="p">,</span> <span class="n">force_all_finite</span><span class="o">=</span><span class="s1">&#39;allow-nan&#39;</span> <span class="k">if</span> <span class="s1">&#39;W&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_allowed_missing_vars</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>

<span class="ne">--&gt; </span><span class="mi">761</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_dims</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">freq_weight</span><span class="p">,</span> <span class="n">sample_var</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

<span class="g g-Whitespace">    </span><span class="mi">763</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">only_final</span><span class="p">:</span>

<span class="g g-Whitespace">    </span><span class="mi">765</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete_outcome</span><span class="p">:</span>



<span class="nn">File ~/Downloads/anaconda3/lib/python3.11/site-packages/econml/_ortho_learner.py:652,</span> in <span class="ni">_OrthoLearner._check_input_dims</span><span class="nt">(self, Y, T, X, W, Z, *other_arrays)</span>

<span class="g g-Whitespace">    </span><span class="mi">650</span> <span class="k">assert</span> <span class="n">shape</span><span class="p">(</span><span class="n">Y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span><span class="p">(</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Dimension mis-match!&quot;</span>

<span class="g g-Whitespace">    </span><span class="mi">651</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="o">*</span><span class="n">other_arrays</span><span class="p">]:</span>

<span class="ne">--&gt; </span><span class="mi">652</span>     <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;Dimension mismatch&quot;</span>

<span class="g g-Whitespace">    </span><span class="mi">653</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_x</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<span class="g g-Whitespace">    </span><span class="mi">654</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_w</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>



<span class="ne">AssertionError</span>: Dimension mismatch
</pre></div>
</div>
</div>
</div>
</section>
<section id="analysis-without-fitting-the-propensity-score">
<h2>6. Analysis without fitting the propensity score<a class="headerlink" href="#analysis-without-fitting-the-propensity-score" title="Link to this heading">#</a></h2>
<p>We see that propensity score is not as important to the results found as clsutering was since it appers to be that the ATE found (0.254) is very much similar to the one found using orthogalization. As we can see in the followin figure, the overlaped distribution are almost the same because they are really close to the 45 degree line that means equiality between the two variables (that are the estimates).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cf_noprop</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>
                            <span class="n">model_y</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span>
                            <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">equalize_cluster_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">clusters</span><span class="o">=</span><span class="n">school_id</span><span class="p">)</span>

<span class="n">cf_noprop</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W_hat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W</span><span class="p">),</span> <span class="n">Y_hat</span><span class="o">=</span><span class="n">Y_hat</span><span class="p">)</span>


<span class="n">ATE_noprop</span> <span class="o">=</span> <span class="n">cf_noprop</span><span class="o">.</span><span class="n">ate</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">ATE_mean_noprop</span> <span class="o">=</span> <span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ATE_ci_noprop</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATE_noprop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% CI for the ATE (noprop): </span><span class="si">{</span><span class="n">ATE_mean_noprop</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">ATE_ci_noprop</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">tau_hat_noprop</span> <span class="o">=</span> <span class="n">cf_noprop</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">tau_hat_noprop</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;orthogonalized causal forest estimates&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;non-orthogonalized causal forest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">)],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">school_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">mat</span><span class="p">),</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">]])</span> <span class="o">/</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span>
<span class="n">school_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">school_X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X1&quot;</span><span class="p">,</span> <span class="s2">&quot;X2&quot;</span><span class="p">,</span> <span class="s2">&quot;X3&quot;</span><span class="p">,</span> <span class="s2">&quot;X4&quot;</span><span class="p">,</span> <span class="s2">&quot;X5&quot;</span><span class="p">,</span> <span class="s2">&quot;XC.1&quot;</span><span class="p">,</span> <span class="s2">&quot;XC.2&quot;</span><span class="p">,</span> <span class="s2">&quot;XC.3&quot;</span><span class="p">,</span> <span class="s2">&quot;XC.4&quot;</span><span class="p">])</span>

<span class="n">dr_score</span> <span class="o">=</span> <span class="n">tau_hat</span> <span class="o">+</span> <span class="n">W</span> <span class="o">/</span> <span class="n">cf</span><span class="o">.</span><span class="n">W_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">cf</span><span class="o">.</span><span class="n">Y_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cf</span><span class="o">.</span><span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_hat</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cf</span><span class="o">.</span><span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">cf</span><span class="o">.</span><span class="n">Y_hat</span> <span class="o">+</span> <span class="n">cf</span><span class="o">.</span><span class="n">W_hat</span> <span class="o">*</span> <span class="n">tau_hat</span><span class="p">)</span>
<span class="n">school_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">mat</span><span class="p">),</span> <span class="n">dr_score</span><span class="p">)</span> <span class="o">/</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span>

<span class="n">school_forest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">school_forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">school_X</span><span class="p">,</span> <span class="n">school_score</span><span class="p">)</span>
<span class="n">school_pred</span> <span class="o">=</span> <span class="n">school_forest</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">school_X</span><span class="p">)</span>


<span class="n">school_DF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">school_X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">school_score</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;school_score&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">school_score</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">school_X</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">ols_results</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ols_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-code-plot-six-plots-in-the-make-some-plots-section-so-explain-what-you-find-there">
<h2>7. The code plot six plots in the Make some plots section, so explain what you find there<a class="headerlink" href="#the-code-plot-six-plots-in-the-make-some-plots-section-so-explain-what-you-find-there" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.labelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.titlesize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;xtick.labelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;ytick.labelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>


<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tau_hat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of tau.hat&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tau_hat_noprop</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of tau.hat.noprop&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tau_hat_noclust</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.55</span><span class="o">/</span><span class="mi">25</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of tau.hat.noclust&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">tau_hat</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">())],</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Boxplot of tau.hat by X1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">tau_hat</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">())],</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Boxplot of tau.hat by X2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">tauhat</span><span class="p">,</span> <span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">tauhat</span><span class="p">,</span> <span class="n">school</span><span class="o">.</span><span class="n">avg</span><span class="o">.</span><span class="n">tauhat</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;average CATE estimate in school&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;school-wise forest predictions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scatter plot of school.avg.tauhat vs. school.pred&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">n_synth</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">p_synth</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">X_synth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_synth</span><span class="p">,</span> <span class="n">p_synth</span><span class="p">))</span>
<span class="n">W_synth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">X_synth</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_synth</span><span class="p">)</span>
<span class="n">Y_synth</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_synth</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_synth</span><span class="p">)</span>

<span class="n">Y_forest_synth</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_synth</span><span class="p">,</span> <span class="n">Y_synth</span><span class="p">)</span>
<span class="n">Y_hat_synth</span> <span class="o">=</span> <span class="n">Y_forest_synth</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_synth</span><span class="p">)</span>
<span class="n">W_forest_synth</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_synth</span><span class="p">,</span> <span class="n">W_synth</span><span class="p">)</span>
<span class="n">W_hat_synth</span> <span class="o">=</span> <span class="n">W_forest_synth</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_synth</span><span class="p">)</span>

<span class="n">cf_synth</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">model_y</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">())</span>
<span class="n">cf_synth</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_synth</span><span class="p">,</span> <span class="n">W_synth</span><span class="p">,</span> <span class="n">X_synth</span><span class="p">,</span> <span class="n">W_hat</span><span class="o">=</span><span class="n">W_hat_synth</span><span class="p">,</span> <span class="n">Y_hat</span><span class="o">=</span><span class="n">Y_hat_synth</span><span class="p">)</span>
<span class="n">ATE_synth</span> <span class="o">=</span> <span class="n">cf_synth</span><span class="o">.</span><span class="n">ate</span><span class="p">(</span><span class="n">X_synth</span><span class="p">)</span>

<span class="n">cf_synth_noprop</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">model_y</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">())</span>
<span class="n">cf_synth_noprop</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_synth</span><span class="p">,</span> <span class="n">W_synth</span><span class="p">,</span> <span class="n">X_synth</span><span class="p">,</span> <span class="n">W_hat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">W_synth</span><span class="p">),</span> <span class="n">Y_hat</span><span class="o">=</span><span class="n">Y_hat_synth</span><span class="p">)</span>
<span class="n">ATE_synth_noprop</span> <span class="o">=</span> <span class="n">cf_synth_noprop</span><span class="o">.</span><span class="n">ate</span><span class="p">(</span><span class="n">X_synth</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% CI for the ATE (synth): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ATE_synth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE_synth</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% CI for the ATE (synth noprop): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ATE_synth_noprop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ATE_synth_noprop</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-school-level-covariates-by-treatment-heterogeneity">
<h2>8. Visualize school-level covariates by treatment heterogeneity<a class="headerlink" href="#visualize-school-level-covariates-by-treatment-heterogeneity" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">school</span><span class="o">.</span><span class="n">X_std</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>


<span class="n">terciles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
                  <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">])</span>
<span class="n">school</span><span class="o">.</span><span class="n">tercile_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">terciles</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>


<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">tercile_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">tercile_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">@</span> \
        <span class="n">school</span><span class="o">.</span><span class="n">tercile_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">school</span><span class="o">.</span><span class="n">X_std</span>


<span class="n">df_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;tercile&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">],</span> <span class="n">school</span><span class="o">.</span><span class="n">tercile_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">means</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                        <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">3</span><span class="p">)})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;tercile&quot;</span><span class="p">,</span> <span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;tercile_plot.pdf&quot;</span><span class="p">)</span>


<span class="n">mean_XC_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;XC.3&quot;</span><span class="p">])</span>
<span class="n">mean_XC_3_low_tercile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;XC.3&quot;</span><span class="p">][</span><span class="n">terciles</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>This graph show us the difference between the mean of the CATE for each school-level covariate considered in the school-wise estimation. We can see that there is not much hetereginty between the means in all covariates but the X1, where the difference between the low and high group of CATEs. This reminds us that even if it seem to be variability in the effects when we divide by this covariate, there’s not enough evidence that controling with the other covariates this effect will remain even when analysing the data at school-level.</p>
</section>
<section id="cate-by-school">
<h2>9. CATE by school<a class="headerlink" href="#cate-by-school" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ord_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="p">))</span>
<span class="n">school_sort</span> <span class="o">=</span> <span class="n">ord_indices</span><span class="p">[</span><span class="n">school</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">tau_hat_noclust</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">school_sort</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">77</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">school</span><span class="o">.</span><span class="n">pred</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;school mean CATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;school&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;estimated CATE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;school_boxplot.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This graph compares per-student predictions from a non-cluster-robust causal forest to per-school mean treatment effect predictions from a forest trained on per-school responses that takes clustering into account. As seen before. We can see that CATE found in when ignoring clusters is higher and more disperse by school than when considering clusters.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="group1_lab3_python.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Proving Neyman Orthogonality</p>
      </div>
    </a>
    <a class="right-next"
       href="group1_lab5_python.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Non-Linear Methods DML</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workgroup-4">WORKGROUP 4</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-libraries">Loading libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-tg-and-create-t4">Filter tg and create T4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-dependent-and-independent-variable">Define dependent and independent variable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-run-the-ols-formula">Create and run the OLS formula</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-bootstrapping-function-like-boot-in-r">Create bootstrapping function like boot in R</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-a-sample-and-run-boot-function">Define a sample and run boot function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-the-results-of-bootstrapping">Save the results of bootstrapping</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#show-the-results-in-a-table">Show the results in a table</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#causal-forest">Causal Forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-the-tree-was-built">1. How the tree was built?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-ate">2. Estimate ATE</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-best-linear-predictor-analysis">3. Run best linear predictor analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-school-wise-heterogeneity">4. Look at school-wise heterogeneity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-ignoring-clusters-how-do-the-results-change">5. Analysis ignoring clusters. How do the results change?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-without-fitting-the-propensity-score">6. Analysis without fitting the propensity score</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-code-plot-six-plots-in-the-make-some-plots-section-so-explain-what-you-find-there">7. The code plot six plots in the Make some plots section, so explain what you find there</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-school-level-covariates-by-treatment-heterogeneity">8. Visualize school-level covariates by treatment heterogeneity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cate-by-school">9. CATE by school</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Josue Maguiña
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>